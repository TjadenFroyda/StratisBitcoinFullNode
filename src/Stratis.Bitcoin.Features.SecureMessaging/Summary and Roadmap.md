## Summary and Roadmap
At first this project started out as an [SDF Bounty](http://stratisdevelopmentfoundation.com/bounties/) for using ECDH to implement secure messaging built on the Stratis Full Node. A similar Proof of Concept was developed for NEO as described [here](https://medium.com/proof-of-working/encrypted-messaging-on-the-neo-blockchain-631bbfcf99f6). As I dug into the bounty, I realized how easy it was to build upon the Stratis Full Node and began to lay a framework to turn this bounty into a fully functional secure messaging DApp built on the Stratis blockchain. "Blockchain made easy" is true; the underlying C# backbone really does make a difference! 

If I can do this, imagine what can be made by more capable hands...

-[@TjadenFroyda](http://www.twitter.com/TjadenFroyda)

### Current State
#### SFN Modfications
- Converted getrawtransaction RPC call to API call for the Stratis Full Node.

*Status: PR submitted.*

#### SymmetricEncryption Class
- AES shared secret encryption/decryption algorithm.  

*Status: Completed.*

#### SecureMessaging Class
- **SetSharedSecretPrivateKey:** Generates a shared secret from an internal private key and external public key. 
- **Encrypt:** Encrypts a plaintext message using ECDH shared secret + AES
- **Decrypt:** Decrypts a plaintext message using ECDH shared secret + AES
- **buildOPReturnMessageList:** Compresses the message string before sending it for batch preparation.
- **prepareOPReturnMessageList:** Creates a batch of 38-40 byte chunks to send as OP_Returns.
  - **TODO:** Because transactions are not added to the chain in the order they are received, messages longer than 40 bytes will need to have an ordering byte prefix. This method needs to be modified to do nothing for compressed, encrypted messages less than 40 bytes, prefix a single byte for messages more than 40 bytes but less than 256*39=9984 bytes and two bytes for larger messages up to 65536*38=2490368 bytes in size.
- **Not Implemented/TODO:**
  - Decompression, reassembly, and decryption of batched encrypted messages. 

*Status: ~80% Complete*

#### SecureMessagingController Class
- **MessageAction:** Used for reflection of encrypted/decrypted messages through the API
- **RecoverWalletFromSeed:** Will generate a full wallet based on the shared secret key. Because of BIP 32, this would ensure that both Alice and Bob would be able to import and watch the same addresses for message sending. To preserve security, they should not send to the same address to prevent linking of accounts by external people. Instead, they should send to distinct addresses generated by the HD wallet. 
  - **TODO:** Since the wallet used for messaging should not be used for funds (shared seed), would like to create a new "Conversation" class that will be a stripped down version of Stratis's watch-only wallet that only keeps track of OP_Returns for watched addresses. Will also limit the number of watched HD generated addresses to about 4-5 per party (8-10 total). 
- **GetPrivateMessagingPubKey:** Generates the publickey to share with the other party during handshake
- **GetSecureMessageTransactionCost:** Calculates the cost of the message being sent using the API's cost function
- **BuildAndSendTransactionBatch:** Prepares, builds, and sends a message using the SFN API. 
  - **TODO:** Add final check to ensure that funds are adequate given the size of the message.

*Status: 80% complete.*

#### SecureMessagingControllerEndpoints
- **encrypt-message:** message reflection (uses wallet private key)
- **decrypt-message:** message reflection (uses wallet private key)
- **get-transaction-cost:** Calculates the cost of sending a message. 
- **build-secure-message:** Builds the secure message batch, but does not send. Use for error checking before sending a message
- **get-securemessaging-publickey:** Retrieves the publickey to be used at handshake, derived from the wallet's private key. **TODO: change**
- **retrieve-message: TODO.** Retrieves a messages from an address/contact, decrypts and decompresses into plaintext. 
- **Additional TODO:** 
  - Create factories for message encryption and decryption. (minor change from current).
  - Consolidate build/send/cost into one function since they do the same thing, with a flag to denote action. (minor change from current)
  - Change Models to accept a Contact and message. (minor change from current)

*Status: 80% done.*

#### Contacts class - TODO
- Changes secure messaging implementation so that each contact will have an associated EC private and public key. This removes any need to access the Stratis wallet's private key and should improve security. 
  - Contacts will be stored in a local file. Can use same method to encrypt private key seeds as Stratis Wallet.
  - Will still need the wallet to send/fund message sending, but can access this through the API/feature interface.  
- TODO
  - Generate Contact and ContactManager class, methods to save and load contacts from local file, get contact by name, ect. 
  - Change SM API endpoints to accept a Contact for either sending or receiving a message.
  - Generate method to determine addresses for sending between parties using HD wallet algorithm. At first will generate only two (or four?) addresses. Will compare public keys in some way to determine which address each contact will use. This will prevent both A or B from sending to the same address and unmasking the association. 

*Status: < 5% done.*

#### Conversation Class
- From the list of contacts, will generate a list of addreses to populate a watch only wallet. This wallet will be a pared down verson of Stratis's watch only wallet and it will only capture OP_Return messages associated with the watched addresses. 
  - Will need to extend the watch only wallet to make this happen.

*Status: <5% done.*

#### Overall TODO 
- Add logging and improve clarity of comments throughout (most comments have been autogenerated from monodevelop). 
- Add error handling for API inputs and associated tests to ensure normal behavior. 


#### Ideas for future directions
- Build OP_Return indexing into the block repository. These would be a subset of the transaction index and would be an alternative to the Azure block explorer bounty.
  - To consider this approach if the Contacts and Conversations watch-only wallet is difficult to implement. 
- MVC messenger service interface that loads contacts and conversations. 


